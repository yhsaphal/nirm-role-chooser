<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Choose Your Role - NIRM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      text-align: center;
    }
    header {
      padding: 20px;
    }
    h1 {
      color: #333;
    }
    .tagline {
      margin: 20px auto;
      font-size: 18px;
      font-style: italic;
      color: #666;
    }
    .role-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 40px;
    }
    button {
      padding: 15px 30px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      color: white;
      background-color: #007BFF;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <header>
    <h1>Choose Your Role</h1>
    <div id="teleprompter" class="tagline"></div>
  </header>

  <div class="role-buttons">
    <button id="individual-btn">I am an Individual</button>
    <button id="business-btn">I am a Business</button>
  </div>

  <script>
    const WEBHOOK_URL = 'https://hook.eu2.make.com/bw7t9bh97mlu13t0cvxw2fy2wfo3vgti';
    const AUTH_TOKEN = localStorage.getItem('auth_token');
    const INDIVIDUAL_FORM = "https://nirm.uk/formindividual";
    const BUSINESS_FORM = "https://nirm.uk/formbusiness";
    const HOME_PAGE = "https://nirm.uk";
    const INDIVIDUAL_DASH = "https://sapphire.nirm.uk";
    const BUSINESS_DASH = "https://business.nirm.uk";

    // Tagline teleprompter
    const TAGLINE_LINES = [
      "Connecting You to the Best",
      "Your Vision, Our Tech",
      "Your Event, Your Way",
      "Built for You",
      "Powered by SapphireAI, Backed by OpenAI",
      "The Clear Path for Seamless Execution",
      "Your Sourcing Solution",
      "Where Events Meet Innovation"
    ];
    const teleprompter = document.getElementById("teleprompter");
    let currentLine = 0;
    const TIME_LIMIT = 2 * 60 * 1000;
    const lineDuration = TIME_LIMIT / TAGLINE_LINES.length;

    function showLine() {
      teleprompter.textContent = TAGLINE_LINES[currentLine];
      currentLine = (currentLine + 1) % TAGLINE_LINES.length;
      setTimeout(showLine, lineDuration);
    }
    showLine();

    // Validate direct access
    if (!AUTH_TOKEN || !window.location.hostname.includes("chooserole.nirm.uk")) {
      console.log("Access invalid: redirecting to homepage.");
      window.location.href = HOME_PAGE;
    }

    // On page load, verify role from backend before deciding redirect
    (async function verifyUserRole() {
      try {
        console.log("Verifying role with backend...");
        const res = await fetch(WEBHOOK_URL + "?checkRole=true", {
          method: "GET",
          headers: { 
            "Authorization": `Bearer ${AUTH_TOKEN}`
          }
        });
        const data = await res.json();
        if (data && data.role) {
          console.log(`Existing role found in backend: ${data.role}`);
          if (data.role === "individual") {
            window.location.href = INDIVIDUAL_DASH;
          } else if (data.role === "business") {
            window.location.href = BUSINESS_DASH;
          }
        } else {
          console.log("No role in backend: staying on chooser page.");
        }
      } catch (err) {
        console.error("Error verifying role, staying on chooser page:", err);
      }
    })();

    // Update role via webhook & redirect
    function updateRole(role) {
      localStorage.setItem('user_role', role); // store locally for quick checks
      console.log(`Sending role "${role}" to backend webhook...`);

      fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${AUTH_TOKEN}`
        },
        body: JSON.stringify({ role })
      })
      .finally(() => {
        console.log(`Redirecting to ${role} form after webhook.`);
        window.location.href = (role === 'individual') ? INDIVIDUAL_FORM : BUSINESS_FORM;
      });
    }

    // Attach button click events
    document.getElementById('individual-btn').addEventListener('click', () => updateRole('individual'));
    document.getElementById('business-btn').addEventListener('click', () => updateRole('business'));

    // Hidden timeout for logging
    setTimeout(() => {
      console.log("Chooserole page TIME_LIMIT reached."); 
    }, TIME_LIMIT);
  </script>
</body>
</html>
